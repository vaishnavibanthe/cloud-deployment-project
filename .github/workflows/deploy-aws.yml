name: Deploy to AWS
 
on:

  workflow_dispatch:

    inputs:

      deployment_type:

        description: 'Deployment Type'

        required: true

        type: choice

        options:

          - lambda

      aws_region:

        description: 'AWS Region'

        required: true

        default: 'us-east-1'

      pulumi_stack:

        description: 'Pulumi Stack'

        required: true

        default: 'dev'
 
env:

  APP_NAME: multi-cloud-api

  AWS_REGION: ${{ github.event.inputs.aws_region }}
 
jobs:

  build-and-push:

    runs-on: ubuntu-latest

    outputs:

      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:

      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4

        with:

          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}

          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          aws-region: ${{ env.AWS_REGION }}

      - id: login-ecr

        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository

        run: |

          aws ecr describe-repositories --repository-names ${{ env.APP_NAME }} || \

          aws ecr create-repository --repository-name ${{ env.APP_NAME }}

      - id: build

        run: |

          docker build --target lambda -t ${{ steps.login-ecr.outputs.registry }}/${{ env.APP_NAME }}:${{ github.sha }} ./api

          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.APP_NAME }}:${{ github.sha }}

          echo "image_uri=${{ steps.login-ecr.outputs.registry }}/${{ env.APP_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT
 
  deploy-lambda:

    needs: build-and-push

    runs-on: ubuntu-latest

    if: github.event.inputs.deployment_type == 'lambda'

    steps:

      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4

        with:

          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}

          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          aws-region: ${{ env.AWS_REGION }}

      - uses: actions/setup-python@v5

        with:

          python-version: '3.11'

      - uses: pulumi/actions@v5

      - name: Install dependencies

        run: |

          cd infra/aws

          pip install -r requirements.txt

      - name: Deploy Lambda with Pulumi

        run: |

          cd infra/aws

          pulumi stack select ${{ github.event.inputs.pulumi_stack }} || pulumi stack init ${{ github.event.inputs.pulumi_stack }}

          pulumi config set appName ${{ env.APP_NAME }}

          pulumi config set imageUri ${{ needs.build-and-push.outputs.image_uri }}

          pulumi up --yes

        env:

          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

 
